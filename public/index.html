<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WordPress Post Submitter</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 20px auto; padding: 0 20px; background-color: #f7f7f7; }
        h1, h2 { color: #111; }
        form { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        label { display: block; margin-bottom: 8px; font-weight: 600; }
        input[type="text"], input[type="password"], textarea { width: 100%; padding: 8px; margin-bottom: 16px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        textarea { height: 150px; resize: vertical; }
        button { background-color: #007BFF; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #0056b3; }
        #logs-container { margin-top: 20px; background: #282c34; color: #abb2bf; padding: 20px; border-radius: 8px; white-space: pre-wrap; font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace; font-size: 14px; line-height: 1.4; max-height: 400px; overflow-y: auto; }
        .log-entry { padding: 2px 0; border-bottom: 1px solid #3e4451; }
        .log-entry:last-child { border-bottom: none; }
        .log-message { color: #61afef; }
        .log-error { color: #e06c75; }
        .log-success { color: #98c379; }
        .log-info { color: #d19a66; }
    </style>
</head>
<body>
    <h1>WordPress Post Submitter</h1>
    <form id="post-form">
        <label for="username">Username:</label>
        <input type="text" id="username" name="username" required value="easyseo">

        <label for="password">Password:</label>
        <input type="password" id="password" name="password" required value="easyseo@gmail.com">
        
        <label for="title">Post Title:</label>
        <input type="text" id="title" name="title" required value="My Awesome Post">

        <label for="content">Post Content:</label>
        <textarea id="content" name="content" required>This is some great content for the post.</textarea>

        <label for="urls">Site URLs (one per line):</label>
        <textarea id="urls" name="urls" required>https://blog2learn.com
https://shotblogs.com</textarea>

        <button type="submit">Submit Posts</button>
    </form>

    <h2>Live Logs</h2>
    <div id="logs-container">
        <div class="log-entry">Waiting for submission...</div>
    </div>

    <script>
        document.getElementById('post-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const logsContainer = document.getElementById('logs-container');
            logsContainer.innerHTML = '<div class="log-entry log-info">üöÄ Initializing request...</div>';

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            data.urls = data.urls.split('\\n').map(url => url.trim()).filter(url => url);

            try {
                // Step 1: Make the POST request
                const response = await fetch('/api/wordpress/posts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`HTTP Error ${response.status}: ${error.error || 'Unknown error'}`);
                }

                const result = await response.json();
                const { requestId } = result;
                
                logsContainer.innerHTML += `<div class="log-entry log-info">üì¨ Request accepted with ID: ${requestId}. Connecting to log stream...</div>`;

                // Step 2: Connect to the WebSocket
                const socket = new WebSocket(`ws://${window.location.host}`);

                socket.onopen = () => {
                    // Step 3: Subscribe to the log channel
                    socket.send(JSON.stringify({
                        type: 'subscribe',
                        requestId: requestId
                    }));
                };

                socket.onmessage = (event) => {
                    const logData = JSON.parse(event.data);
                    const logEntry = document.createElement('div');
                    logEntry.className = 'log-entry';
                    
                    let messageClass = 'log-message';
                    if (logData.message && logData.message.includes('‚ùå')) {
                        messageClass = 'log-error';
                    } else if (logData.message && logData.message.includes('‚úÖ')) {
                        messageClass = 'log-success';
                    } else if (logData.type === 'info') {
                        messageClass = 'log-info';
                    }

                    const timestamp = logData.timestamp ? new Date(logData.timestamp).toLocaleTimeString() : '';
                    logEntry.innerHTML = `<span>[${timestamp}]</span> <span class="${messageClass}">${logData.message}</span>`;
                    logsContainer.appendChild(logEntry);
                    logsContainer.scrollTop = logsContainer.scrollHeight; // Auto-scroll
                };

                socket.onclose = () => {
                    logsContainer.innerHTML += '<div class="log-entry log-info">üîå WebSocket connection closed.</div>';
                };

                socket.onerror = (error) => {
                    console.error('WebSocket Error:', error);
                    logsContainer.innerHTML += `<div class="log-entry log-error">üîå WebSocket error. See browser console for details.</div>`;
                };

            } catch (error) {
                logsContainer.innerHTML += `<div class="log-entry log-error">Failed to submit request: ${error.message}</div>`;
            }
        });
    </script>
</body>
</html> 